# Save Image Extended æ’ä»¶ä¼˜åŒ–å»ºè®®

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡
å°†ç°æœ‰çš„å•ä½“æ¶æ„é‡æ„ä¸ºæ¨¡å—åŒ–ã€é«˜æ€§èƒ½ã€ç”¨æˆ·å‹å¥½çš„æ’ä»¶ç³»ç»Ÿã€‚

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è®¡æ•°å™¨ä¼˜åŒ–
```python
class CounterManager:
    """æ™ºèƒ½è®¡æ•°å™¨ç®¡ç†"""
    def __init__(self):
        self._counter_cache = {}
    
    def get_next_counter(self, folder_path, pattern):
        # ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤æ‰«æç›®å½•
        cache_key = f"{folder_path}:{pattern}"
        if cache_key not in self._counter_cache:
            self._counter_cache[cache_key] = self._scan_directory(folder_path, pattern)
        return self._counter_cache[cache_key] + 1
```

### 2. æ‰¹é‡å¤„ç†ä¼˜åŒ–
```python
class BatchImageProcessor:
    """æ‰¹é‡å›¾åƒå¤„ç†å™¨"""
    def process_images(self, images, config):
        # é¢„å¤„ç†é…ç½®
        metadata = self._prepare_metadata_once(config)
        
        # æ‰¹é‡è½¬æ¢å›¾åƒæ ¼å¼
        converted_images = self._batch_convert_images(images)
        
        # å¹¶è¡Œä¿å­˜
        with ThreadPoolExecutor() as executor:
            futures = [
                executor.submit(self._save_single_image, img, metadata, config)
                for img in converted_images
            ]
```

### 3. å…ƒæ•°æ®ç¼“å­˜
```python
class MetadataCache:
    """å…ƒæ•°æ®ç¼“å­˜ç®¡ç†"""
    def __init__(self):
        self._cache = {}
    
    def get_metadata(self, prompt_hash, format_type):
        cache_key = f"{prompt_hash}:{format_type}"
        if cache_key not in self._cache:
            self._cache[cache_key] = self._generate_metadata(prompt_hash, format_type)
        return self._cache[cache_key]
```

## ğŸ¨ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 1. é…ç½®æ¨¡æ¿ç³»ç»Ÿ
```python
class ConfigTemplate:
    """é…ç½®æ¨¡æ¿ç®¡ç†"""
    TEMPLATES = {
        "simple": {
            "filename_keys": "sampler_name, steps",
            "foldername_keys": "ckpt_name",
            "delimiter": "-"
        },
        "detailed": {
            "filename_keys": "sampler_name, cfg, steps, %Y-%m-%d_%H-%M-%S",
            "foldername_keys": "ckpt_name, ./sampler_name",
            "delimiter": "_"
        },
        "minimal": {
            "filename_keys": "%Y%m%d_%H%M%S",
            "foldername_keys": "",
            "delimiter": ""
        }
    }
```

### 2. æ–‡ä»¶åé¢„è§ˆåŠŸèƒ½
```python
class FileNamePreview:
    """å®æ—¶æ–‡ä»¶åé¢„è§ˆ"""
    def preview_filename(self, config, sample_prompt):
        generator = FileNameGenerator(config)
        preview = generator.generate_name(sample_prompt, dry_run=True)
        return {
            "filename": preview.filename,
            "folder_path": preview.folder_path,
            "full_path": preview.full_path,
            "warnings": preview.warnings
        }
```

### 3. æ™ºèƒ½é”™è¯¯å¤„ç†
```python
class ValidationError(Exception):
    """è‡ªå®šä¹‰éªŒè¯é”™è¯¯"""
    def __init__(self, field, value, suggestion=None):
        self.field = field
        self.value = value
        self.suggestion = suggestion
        super().__init__(f"Invalid {field}: {value}")

class ConfigValidator:
    """é…ç½®éªŒè¯å™¨"""
    def validate_filename_keys(self, keys):
        for key in keys:
            if not self._is_valid_key(key):
                suggestion = self._suggest_correction(key)
                raise ValidationError("filename_key", key, suggestion)
```

## ğŸ—ï¸ æ¶æ„é‡æ„å»ºè®®

### 1. ç­–ç•¥æ¨¡å¼ - æ ¼å¼å¤„ç†
```python
class FormatStrategy:
    """å›¾åƒæ ¼å¼å¤„ç†ç­–ç•¥åŸºç±»"""
    def save_image(self, image, path, metadata, quality):
        raise NotImplementedError

class PNGStrategy(FormatStrategy):
    def save_image(self, image, path, metadata, quality):
        kwargs = {"pnginfo": metadata, "compress_level": 9}
        image.save(path, **kwargs)

class WebPStrategy(FormatStrategy):
    def save_image(self, image, path, metadata, quality):
        kwargs = {"exif": metadata, "quality": quality}
        if quality == 100:
            kwargs["lossless"] = True
        image.save(path, **kwargs)
```

### 2. è§‚å¯Ÿè€…æ¨¡å¼ - äº‹ä»¶ç³»ç»Ÿ
```python
class SaveEvent:
    """ä¿å­˜äº‹ä»¶"""
    def __init__(self, image_path, metadata, success=True, error=None):
        self.image_path = image_path
        self.metadata = metadata
        self.success = success
        self.error = error

class EventManager:
    """äº‹ä»¶ç®¡ç†å™¨"""
    def __init__(self):
        self._observers = []
    
    def add_observer(self, observer):
        self._observers.append(observer)
    
    def notify(self, event):
        for observer in self._observers:
            observer.handle_event(event)
```

## ğŸ”§ å…·ä½“å®ç°å»ºè®®

### 1. é…ç½®ç®¡ç†é‡æ„
```python
@dataclass
class SaveConfig:
    """ä¿å­˜é…ç½®æ•°æ®ç±»"""
    filename_prefix: str = "ComfyUI"
    filename_keys: List[str] = field(default_factory=lambda: ["sampler_name", "cfg", "steps"])
    foldername_prefix: str = ""
    foldername_keys: List[str] = field(default_factory=lambda: ["ckpt_name"])
    delimiter: str = "-"
    output_format: str = ".webp"
    quality: int = 75
    save_metadata: bool = True
    counter_digits: int = 4
    
    def validate(self):
        """é…ç½®éªŒè¯"""
        validator = ConfigValidator()
        validator.validate(self)
```

### 2. å¼‚æ­¥å¤„ç†æ”¯æŒ
```python
import asyncio
from concurrent.futures import ThreadPoolExecutor

class AsyncImageSaver:
    """å¼‚æ­¥å›¾åƒä¿å­˜å™¨"""
    def __init__(self, max_workers=4):
        self.executor = ThreadPoolExecutor(max_workers=max_workers)
    
    async def save_images_async(self, images, config):
        """å¼‚æ­¥ä¿å­˜å¤šå¼ å›¾ç‰‡"""
        tasks = []
        for image in images:
            task = asyncio.create_task(
                self._save_single_image_async(image, config)
            )
            tasks.append(task)
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        return results
```

## ğŸ“ˆ æ€§èƒ½ç›‘æ§å»ºè®®

### 1. æ€§èƒ½æŒ‡æ ‡æ”¶é›†
```python
class PerformanceMonitor:
    """æ€§èƒ½ç›‘æ§"""
    def __init__(self):
        self.metrics = {
            "save_time": [],
            "file_size": [],
            "metadata_size": [],
            "error_count": 0
        }
    
    def record_save_operation(self, duration, file_size, metadata_size):
        self.metrics["save_time"].append(duration)
        self.metrics["file_size"].append(file_size)
        self.metrics["metadata_size"].append(metadata_size)
    
    def get_statistics(self):
        return {
            "avg_save_time": np.mean(self.metrics["save_time"]),
            "total_files": len(self.metrics["save_time"]),
            "error_rate": self.metrics["error_count"] / len(self.metrics["save_time"])
        }
```

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

### é«˜ä¼˜å…ˆçº§ (ç«‹å³å®æ–½)
1. **é…ç½®éªŒè¯å’Œé”™è¯¯å¤„ç†æ”¹è¿›**
2. **è®¡æ•°å™¨æ€§èƒ½ä¼˜åŒ–**
3. **åŸºæœ¬çš„ä»£ç é‡æ„ï¼ˆæ‹†åˆ†å¤§æ–¹æ³•ï¼‰**

### ä¸­ä¼˜å…ˆçº§ (çŸ­æœŸå®æ–½)
1. **æ–‡ä»¶åé¢„è§ˆåŠŸèƒ½**
2. **é…ç½®æ¨¡æ¿ç³»ç»Ÿ**
3. **å…ƒæ•°æ®ç¼“å­˜ä¼˜åŒ–**

### ä½ä¼˜å…ˆçº§ (é•¿æœŸè§„åˆ’)
1. **å®Œæ•´æ¶æ„é‡æ„**
2. **å¼‚æ­¥å¤„ç†æ”¯æŒ**
3. **æ’ä»¶ç³»ç»Ÿæ‰©å±•**

## ï¿½ ç§»é™¤Webç»„ä»¶å»ºè®®

### å½“å‰Webç»„ä»¶åˆ†æ
å½“å‰çš„webç»„ä»¶åŠŸèƒ½éå¸¸æœ‰é™ï¼š
- **contextmenu.js**: åªæ·»åŠ äº†ä¸€ä¸ªå¸®åŠ©å¼¹çª—è®¾ç½®
- **shared_utils.js**: é€šç”¨å·¥å…·å‡½æ•°ï¼Œä½†æœªè¢«ä½¿ç”¨
- **é™æ€èµ„æº**: åªæ˜¯ä¸ºäº†è®¿é—®assetsç›®å½•

### çº¯Pythonå®ç°çš„ä¼˜åŠ¿

#### 1. ç®€åŒ–æ¶æ„
```python
# ç§»é™¤webä¾èµ–ï¼Œç®€åŒ–__init__.py
from .save_image_extended import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS

__all__ = ['NODE_CLASS_MAPPINGS', 'NODE_DISPLAY_NAME_MAPPINGS']

# ä¸å†éœ€è¦:
# - WEB_DIRECTORY
# - aiohttpå¯¼å…¥
# - é™æ€è·¯ç”±è®¾ç½®
```

#### 2. é…ç½®ç®¡ç†çº¯PythonåŒ–
```python
class SaveImageConfig:
    """çº¯Pythoné…ç½®ç®¡ç†"""

    # æ›¿ä»£JavaScriptè®¾ç½®çš„Pythoné…ç½®
    HELP_ENABLED = True

    # é¢„è®¾æ¨¡æ¿ï¼ˆæ›¿ä»£webç•Œé¢é€‰æ‹©ï¼‰
    PRESETS = {
        "simple": {
            "filename_keys": ["sampler_name", "steps"],
            "foldername_keys": ["ckpt_name"],
            "delimiter": "-"
        },
        "detailed": {
            "filename_keys": ["sampler_name", "cfg", "steps", "%Y-%m-%d_%H-%M-%S"],
            "foldername_keys": ["ckpt_name", "./sampler_name"],
            "delimiter": "_"
        }
    }

    @classmethod
    def get_preset(cls, preset_name):
        """è·å–é¢„è®¾é…ç½®"""
        return cls.PRESETS.get(preset_name, cls.PRESETS["simple"])
```

#### 3. å¸®åŠ©ç³»ç»ŸPythonåŒ–
```python
class HelpSystem:
    """çº¯Pythonå¸®åŠ©ç³»ç»Ÿ"""

    HELP_TEXT = {
        "filename_keys": """
        æ–‡ä»¶åé”®å€¼è¯´æ˜ï¼š
        - sampler_name: é‡‡æ ·å™¨åç§°
        - cfg: CFGå€¼
        - steps: æ­¥æ•°
        - %Y-%m-%d: æ—¥æœŸæ ¼å¼
        - èŠ‚ç‚¹ID.å‚æ•°å: å¦‚ "5.seed" è·å–èŠ‚ç‚¹5çš„seedå€¼
        """,
        "foldername_keys": """
        æ–‡ä»¶å¤¹é”®å€¼è¯´æ˜ï¼š
        - ckpt_name: æ¨¡å‹åç§°
        - ./å­æ–‡ä»¶å¤¹: åˆ›å»ºå­æ–‡ä»¶å¤¹
        - ../ä¸Šçº§æ–‡ä»¶å¤¹: åˆ›å»ºä¸Šçº§æ–‡ä»¶å¤¹
        """
    }

    @classmethod
    def get_help(cls, field_name):
        """è·å–å­—æ®µå¸®åŠ©ä¿¡æ¯"""
        return cls.HELP_TEXT.get(field_name, "æš‚æ— å¸®åŠ©ä¿¡æ¯")
```

#### 4. éªŒè¯å’Œé¢„è§ˆçº¯PythonåŒ–
```python
class ConfigValidator:
    """é…ç½®éªŒè¯å™¨"""

    def validate_filename_keys(self, keys_str):
        """éªŒè¯æ–‡ä»¶åé”®å€¼"""
        keys = [k.strip() for k in keys_str.split(',')]
        errors = []
        warnings = []

        for key in keys:
            if not key:
                continue

            # æ£€æŸ¥èŠ‚ç‚¹å¼•ç”¨æ ¼å¼
            if '.' in key and not '%' in key:
                parts = key.split('.')
                if len(parts) == 2 and parts[0].isdigit():
                    # èŠ‚ç‚¹å¼•ç”¨æ ¼å¼æ­£ç¡®
                    continue
                else:
                    errors.append(f"èŠ‚ç‚¹å¼•ç”¨æ ¼å¼é”™è¯¯: {key}")

            # æ£€æŸ¥æ—¶é—´æ ¼å¼
            elif '%' in key:
                try:
                    datetime.now().strftime(key)
                except ValueError:
                    errors.append(f"æ—¶é—´æ ¼å¼é”™è¯¯: {key}")

        return {
            "valid": len(errors) == 0,
            "errors": errors,
            "warnings": warnings
        }

    def preview_filename(self, config, sample_prompt=None):
        """é¢„è§ˆç”Ÿæˆçš„æ–‡ä»¶å"""
        # ä½¿ç”¨ç¤ºä¾‹æ•°æ®ç”Ÿæˆé¢„è§ˆ
        sample_data = {
            "sampler_name": "euler_a",
            "cfg": "7.5",
            "steps": "20"
        }

        generator = FileNameGenerator(config)
        return generator.generate_preview(sample_data)
```

### ç§»é™¤æ­¥éª¤

#### ç¬¬ä¸€æ­¥ï¼šæ¸…ç†æ–‡ä»¶ç»“æ„
```bash
# åˆ é™¤webç›¸å…³æ–‡ä»¶
rm -rf web/
rm -rf assets/  # å¦‚æœä¸éœ€è¦çš„è¯
```

#### ç¬¬äºŒæ­¥ï¼šç®€åŒ–__init__.py
```python
# æ–°çš„ç®€åŒ–ç‰ˆæœ¬
from .save_image_extended import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS

__all__ = ['NODE_CLASS_MAPPINGS', 'NODE_DISPLAY_NAME_MAPPINGS']
```

#### ç¬¬ä¸‰æ­¥ï¼šå¢å¼ºPythoné…ç½®
```python
# åœ¨SaveImageExtendedç±»ä¸­æ·»åŠ 
@classmethod
def get_config_help(cls):
    """è·å–é…ç½®å¸®åŠ©ä¿¡æ¯"""
    return {
        "filename_keys": "æ”¯æŒçš„é”®å€¼: sampler_name, cfg, steps, èŠ‚ç‚¹ID.å‚æ•°å, %æ—¶é—´æ ¼å¼%",
        "foldername_keys": "æ”¯æŒçš„é”®å€¼: ckpt_name, ./å­æ–‡ä»¶å¤¹, èŠ‚ç‚¹ID.å‚æ•°å",
        "delimiter": "æ–‡ä»¶ååˆ†éš”ç¬¦ï¼Œå»ºè®®ä½¿ç”¨ - æˆ– _",
        "quality": "å›¾åƒè´¨é‡ 1-100ï¼Œ100ä¸ºæ— æŸï¼ˆä»…AVIF/WebPï¼‰"
    }

@classmethod
def validate_config(cls, config):
    """éªŒè¯é…ç½®æœ‰æ•ˆæ€§"""
    validator = ConfigValidator()
    return validator.validate_all(config)
```

### ä¼˜åŠ¿æ€»ç»“

1. **ç®€åŒ–éƒ¨ç½²** - æ— éœ€å¤„ç†é™æ€æ–‡ä»¶å’Œwebè·¯ç”±
2. **å‡å°‘ä¾èµ–** - ç§»é™¤aiohttpç­‰webç›¸å…³ä¾èµ–
3. **æé«˜æ€§èƒ½** - æ— webæœåŠ¡å™¨å¼€é”€
4. **æ˜“äºç»´æŠ¤** - å•ä¸€è¯­è¨€æ ˆï¼Œæ— éœ€ç»´æŠ¤JavaScript
5. **æ›´å¥½é›†æˆ** - ä¸ComfyUIçš„Pythonç”Ÿæ€æ›´å¥½é›†æˆ
6. **è·¨å¹³å°** - é¿å…webç›¸å…³çš„è·¨å¹³å°é—®é¢˜

## ï¿½ğŸ“ å®æ–½å»ºè®®

1. **æ¸è¿›å¼é‡æ„**ï¼šä¸è¦ä¸€æ¬¡æ€§é‡å†™æ‰€æœ‰ä»£ç ï¼Œè€Œæ˜¯é€æ­¥é‡æ„
2. **å‘åå…¼å®¹**ï¼šç¡®ä¿æ–°ç‰ˆæœ¬ä¸ç°æœ‰é…ç½®å…¼å®¹
3. **å……åˆ†æµ‹è¯•**ï¼šä¸ºæ¯ä¸ªæ¨¡å—ç¼–å†™å•å…ƒæµ‹è¯•
4. **æ–‡æ¡£æ›´æ–°**ï¼šåŒæ­¥æ›´æ–°ç”¨æˆ·æ–‡æ¡£å’Œå¼€å‘æ–‡æ¡£
5. **æ€§èƒ½åŸºå‡†**ï¼šå»ºç«‹æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œç¡®ä¿ä¼˜åŒ–æ•ˆæœ
6. **ç§»é™¤Webç»„ä»¶**ï¼šä¼˜å…ˆç§»é™¤ä¸å¿…è¦çš„webä¾èµ–ï¼Œç®€åŒ–æ¶æ„

é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼Œæ’ä»¶å°†å˜å¾—æ›´åŠ é«˜æ•ˆã€æ˜“ç”¨å’Œå¯ç»´æŠ¤ã€‚
