# Save Image Extended 插件优化建议

## 🎯 优化目标
将现有的单体架构重构为模块化、高性能、用户友好的插件系统。

## 📊 性能优化建议

### 1. 计数器优化
```python
class CounterManager:
    """智能计数器管理"""
    def __init__(self):
        self._counter_cache = {}
    
    def get_next_counter(self, folder_path, pattern):
        # 使用缓存避免重复扫描目录
        cache_key = f"{folder_path}:{pattern}"
        if cache_key not in self._counter_cache:
            self._counter_cache[cache_key] = self._scan_directory(folder_path, pattern)
        return self._counter_cache[cache_key] + 1
```

### 2. 批量处理优化
```python
class BatchImageProcessor:
    """批量图像处理器"""
    def process_images(self, images, config):
        # 预处理配置
        metadata = self._prepare_metadata_once(config)
        
        # 批量转换图像格式
        converted_images = self._batch_convert_images(images)
        
        # 并行保存
        with ThreadPoolExecutor() as executor:
            futures = [
                executor.submit(self._save_single_image, img, metadata, config)
                for img in converted_images
            ]
```

### 3. 元数据缓存
```python
class MetadataCache:
    """元数据缓存管理"""
    def __init__(self):
        self._cache = {}
    
    def get_metadata(self, prompt_hash, format_type):
        cache_key = f"{prompt_hash}:{format_type}"
        if cache_key not in self._cache:
            self._cache[cache_key] = self._generate_metadata(prompt_hash, format_type)
        return self._cache[cache_key]
```

## 🎨 用户体验改进

### 1. 配置模板系统
```python
class ConfigTemplate:
    """配置模板管理"""
    TEMPLATES = {
        "simple": {
            "filename_keys": "sampler_name, steps",
            "foldername_keys": "ckpt_name",
            "delimiter": "-"
        },
        "detailed": {
            "filename_keys": "sampler_name, cfg, steps, %Y-%m-%d_%H-%M-%S",
            "foldername_keys": "ckpt_name, ./sampler_name",
            "delimiter": "_"
        },
        "minimal": {
            "filename_keys": "%Y%m%d_%H%M%S",
            "foldername_keys": "",
            "delimiter": ""
        }
    }
```

### 2. 文件名预览功能
```python
class FileNamePreview:
    """实时文件名预览"""
    def preview_filename(self, config, sample_prompt):
        generator = FileNameGenerator(config)
        preview = generator.generate_name(sample_prompt, dry_run=True)
        return {
            "filename": preview.filename,
            "folder_path": preview.folder_path,
            "full_path": preview.full_path,
            "warnings": preview.warnings
        }
```

### 3. 智能错误处理
```python
class ValidationError(Exception):
    """自定义验证错误"""
    def __init__(self, field, value, suggestion=None):
        self.field = field
        self.value = value
        self.suggestion = suggestion
        super().__init__(f"Invalid {field}: {value}")

class ConfigValidator:
    """配置验证器"""
    def validate_filename_keys(self, keys):
        for key in keys:
            if not self._is_valid_key(key):
                suggestion = self._suggest_correction(key)
                raise ValidationError("filename_key", key, suggestion)
```

## 🏗️ 架构重构建议

### 1. 策略模式 - 格式处理
```python
class FormatStrategy:
    """图像格式处理策略基类"""
    def save_image(self, image, path, metadata, quality):
        raise NotImplementedError

class PNGStrategy(FormatStrategy):
    def save_image(self, image, path, metadata, quality):
        kwargs = {"pnginfo": metadata, "compress_level": 9}
        image.save(path, **kwargs)

class WebPStrategy(FormatStrategy):
    def save_image(self, image, path, metadata, quality):
        kwargs = {"exif": metadata, "quality": quality}
        if quality == 100:
            kwargs["lossless"] = True
        image.save(path, **kwargs)
```

### 2. 观察者模式 - 事件系统
```python
class SaveEvent:
    """保存事件"""
    def __init__(self, image_path, metadata, success=True, error=None):
        self.image_path = image_path
        self.metadata = metadata
        self.success = success
        self.error = error

class EventManager:
    """事件管理器"""
    def __init__(self):
        self._observers = []
    
    def add_observer(self, observer):
        self._observers.append(observer)
    
    def notify(self, event):
        for observer in self._observers:
            observer.handle_event(event)
```

## 🔧 具体实现建议

### 1. 配置管理重构
```python
@dataclass
class SaveConfig:
    """保存配置数据类"""
    filename_prefix: str = "ComfyUI"
    filename_keys: List[str] = field(default_factory=lambda: ["sampler_name", "cfg", "steps"])
    foldername_prefix: str = ""
    foldername_keys: List[str] = field(default_factory=lambda: ["ckpt_name"])
    delimiter: str = "-"
    output_format: str = ".webp"
    quality: int = 75
    save_metadata: bool = True
    counter_digits: int = 4
    
    def validate(self):
        """配置验证"""
        validator = ConfigValidator()
        validator.validate(self)
```

### 2. 异步处理支持
```python
import asyncio
from concurrent.futures import ThreadPoolExecutor

class AsyncImageSaver:
    """异步图像保存器"""
    def __init__(self, max_workers=4):
        self.executor = ThreadPoolExecutor(max_workers=max_workers)
    
    async def save_images_async(self, images, config):
        """异步保存多张图片"""
        tasks = []
        for image in images:
            task = asyncio.create_task(
                self._save_single_image_async(image, config)
            )
            tasks.append(task)
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        return results
```

## 📈 性能监控建议

### 1. 性能指标收集
```python
class PerformanceMonitor:
    """性能监控"""
    def __init__(self):
        self.metrics = {
            "save_time": [],
            "file_size": [],
            "metadata_size": [],
            "error_count": 0
        }
    
    def record_save_operation(self, duration, file_size, metadata_size):
        self.metrics["save_time"].append(duration)
        self.metrics["file_size"].append(file_size)
        self.metrics["metadata_size"].append(metadata_size)
    
    def get_statistics(self):
        return {
            "avg_save_time": np.mean(self.metrics["save_time"]),
            "total_files": len(self.metrics["save_time"]),
            "error_rate": self.metrics["error_count"] / len(self.metrics["save_time"])
        }
```

## 🎯 优先级建议

### 高优先级 (立即实施)
1. **配置验证和错误处理改进**
2. **计数器性能优化**
3. **基本的代码重构（拆分大方法）**

### 中优先级 (短期实施)
1. **文件名预览功能**
2. **配置模板系统**
3. **元数据缓存优化**

### 低优先级 (长期规划)
1. **完整架构重构**
2. **异步处理支持**
3. **插件系统扩展**

## � 移除Web组件建议

### 当前Web组件分析
当前的web组件功能非常有限：
- **contextmenu.js**: 只添加了一个帮助弹窗设置
- **shared_utils.js**: 通用工具函数，但未被使用
- **静态资源**: 只是为了访问assets目录

### 纯Python实现的优势

#### 1. 简化架构
```python
# 移除web依赖，简化__init__.py
from .save_image_extended import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS

__all__ = ['NODE_CLASS_MAPPINGS', 'NODE_DISPLAY_NAME_MAPPINGS']

# 不再需要:
# - WEB_DIRECTORY
# - aiohttp导入
# - 静态路由设置
```

#### 2. 配置管理纯Python化
```python
class SaveImageConfig:
    """纯Python配置管理"""

    # 替代JavaScript设置的Python配置
    HELP_ENABLED = True

    # 预设模板（替代web界面选择）
    PRESETS = {
        "simple": {
            "filename_keys": ["sampler_name", "steps"],
            "foldername_keys": ["ckpt_name"],
            "delimiter": "-"
        },
        "detailed": {
            "filename_keys": ["sampler_name", "cfg", "steps", "%Y-%m-%d_%H-%M-%S"],
            "foldername_keys": ["ckpt_name", "./sampler_name"],
            "delimiter": "_"
        }
    }

    @classmethod
    def get_preset(cls, preset_name):
        """获取预设配置"""
        return cls.PRESETS.get(preset_name, cls.PRESETS["simple"])
```

#### 3. 帮助系统Python化
```python
class HelpSystem:
    """纯Python帮助系统"""

    HELP_TEXT = {
        "filename_keys": """
        文件名键值说明：
        - sampler_name: 采样器名称
        - cfg: CFG值
        - steps: 步数
        - %Y-%m-%d: 日期格式
        - 节点ID.参数名: 如 "5.seed" 获取节点5的seed值
        """,
        "foldername_keys": """
        文件夹键值说明：
        - ckpt_name: 模型名称
        - ./子文件夹: 创建子文件夹
        - ../上级文件夹: 创建上级文件夹
        """
    }

    @classmethod
    def get_help(cls, field_name):
        """获取字段帮助信息"""
        return cls.HELP_TEXT.get(field_name, "暂无帮助信息")
```

#### 4. 验证和预览纯Python化
```python
class ConfigValidator:
    """配置验证器"""

    def validate_filename_keys(self, keys_str):
        """验证文件名键值"""
        keys = [k.strip() for k in keys_str.split(',')]
        errors = []
        warnings = []

        for key in keys:
            if not key:
                continue

            # 检查节点引用格式
            if '.' in key and not '%' in key:
                parts = key.split('.')
                if len(parts) == 2 and parts[0].isdigit():
                    # 节点引用格式正确
                    continue
                else:
                    errors.append(f"节点引用格式错误: {key}")

            # 检查时间格式
            elif '%' in key:
                try:
                    datetime.now().strftime(key)
                except ValueError:
                    errors.append(f"时间格式错误: {key}")

        return {
            "valid": len(errors) == 0,
            "errors": errors,
            "warnings": warnings
        }

    def preview_filename(self, config, sample_prompt=None):
        """预览生成的文件名"""
        # 使用示例数据生成预览
        sample_data = {
            "sampler_name": "euler_a",
            "cfg": "7.5",
            "steps": "20"
        }

        generator = FileNameGenerator(config)
        return generator.generate_preview(sample_data)
```

### 移除步骤

#### 第一步：清理文件结构
```bash
# 删除web相关文件
rm -rf web/
rm -rf assets/  # 如果不需要的话
```

#### 第二步：简化__init__.py
```python
# 新的简化版本
from .save_image_extended import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS

__all__ = ['NODE_CLASS_MAPPINGS', 'NODE_DISPLAY_NAME_MAPPINGS']
```

#### 第三步：增强Python配置
```python
# 在SaveImageExtended类中添加
@classmethod
def get_config_help(cls):
    """获取配置帮助信息"""
    return {
        "filename_keys": "支持的键值: sampler_name, cfg, steps, 节点ID.参数名, %时间格式%",
        "foldername_keys": "支持的键值: ckpt_name, ./子文件夹, 节点ID.参数名",
        "delimiter": "文件名分隔符，建议使用 - 或 _",
        "quality": "图像质量 1-100，100为无损（仅AVIF/WebP）"
    }

@classmethod
def validate_config(cls, config):
    """验证配置有效性"""
    validator = ConfigValidator()
    return validator.validate_all(config)
```

### 优势总结

1. **简化部署** - 无需处理静态文件和web路由
2. **减少依赖** - 移除aiohttp等web相关依赖
3. **提高性能** - 无web服务器开销
4. **易于维护** - 单一语言栈，无需维护JavaScript
5. **更好集成** - 与ComfyUI的Python生态更好集成
6. **跨平台** - 避免web相关的跨平台问题

## �📝 实施建议

1. **渐进式重构**：不要一次性重写所有代码，而是逐步重构
2. **向后兼容**：确保新版本与现有配置兼容
3. **充分测试**：为每个模块编写单元测试
4. **文档更新**：同步更新用户文档和开发文档
5. **性能基准**：建立性能基准测试，确保优化效果
6. **移除Web组件**：优先移除不必要的web依赖，简化架构

通过这些优化，插件将变得更加高效、易用和可维护。
