# Save Image Extended v3.0 用户手册

## 概述

Save Image Extended 是一个功能强大的 ComfyUI 插件，用于保存图像到多种格式，支持自定义文件名、文件夹结构、元数据保存等高级功能。

## 主要特性

### 🎯 核心功能
- **多格式支持**: PNG, WebP, JPEG, AVIF, JXL, TIFF, GIF, BMP
- **自定义命名**: 灵活的文件名和文件夹命名系统
- **元数据保存**: 保留生成参数和提示词信息
- **批量处理**: 高效的批量图像保存
- **作业数据导出**: JSON格式的详细生成信息

### ⚡ 性能特性
- **智能缓存**: 文件名生成和参数提取缓存
- **并行处理**: 多线程批量保存
- **内存优化**: 自动内存管理和清理
- **错误恢复**: 完善的错误处理机制

## 安装说明

### 基础安装
1. 将插件文件夹复制到 ComfyUI 的 `custom_nodes` 目录
2. 重启 ComfyUI

### 可选依赖
```bash
# AVIF 支持
pip install pillow-avif-plugin

# JXL 支持 (需要 MSVC 编译环境)
pip install jxlpy
```

## 使用指南

### 基本使用

1. **添加节点**: 在 ComfyUI 中搜索 "Save Image Extended"
2. **连接图像**: 将图像输出连接到节点的 images 输入
3. **配置参数**: 根据需要调整各项设置
4. **运行工作流**: 图像将按配置保存到输出目录

### 参数说明

#### 文件命名参数
- **filename_prefix**: 文件名前缀 (默认: "ComfyUI")
- **filename_keys**: 文件名组成元素，用逗号分隔
- **delimiter**: 文件名元素间的分隔符 (默认: "-")

#### 文件夹参数
- **foldername_prefix**: 文件夹名前缀
- **foldername_keys**: 文件夹名组成元素

#### 格式和质量
- **output_format**: 输出格式 (.webp, .png, .jpg 等)
- **quality**: 图像质量 (1-100，适用于有损格式)

#### 计数器设置
- **counter_digits**: 计数器位数 (默认: 4)
- **counter_position**: 计数器位置 (first/last)
- **one_counter_per_folder**: 每个文件夹独立计数

#### 元数据和作业数据
- **save_metadata**: 是否保存元数据
- **save_job_data**: 作业数据保存级别
- **job_data_per_image**: 每张图像单独的作业数据文件

### 高级功能

#### 1. 参数引用系统
可以在文件名中引用工作流中的任何参数：

```
# 基本参数引用
sampler_name, cfg, steps

# 节点参数引用 (节点ID.参数名)
5.seed, 3.ckpt_name

# 时间格式
%Y-%m-%d, %H-%M-%S
```

#### 2. 文件夹结构
支持创建复杂的文件夹结构：

```
# 基本文件夹
ckpt_name

# 嵌套文件夹
%Y/%m/%d

# 混合结构
models/ckpt_name/%F
```

#### 3. 配置预设
插件提供三种预设配置：

- **基础配置**: 简单的文件名和格式设置
- **高级配置**: 完整的自定义选项
- **专业配置**: 包含元数据和作业数据导出

## 配置示例

### 示例 1: 基础配置
```
filename_prefix: "AI_Art"
filename_keys: "sampler_name, steps, %H-%M-%S"
output_format: ".webp"
quality: 85
```
生成文件名: `AI_Art-euler-20-14-30-25_0001.webp`

### 示例 2: 高级配置
```
filename_prefix: ""
filename_keys: "5.ckpt_name, sampler_name, cfg, steps, %F"
foldername_keys: "%Y/%m, 5.ckpt_name"
delimiter: "_"
counter_position: "first"
```
生成路径: `2024/01/sd_xl_base/0001_sd_xl_base_euler_7.5_20_2024-01-15.webp`

### 示例 3: 专业配置
```
filename_keys: "sampler_name, scheduler, cfg, steps, 5.seed"
save_metadata: true
save_job_data: "prompt"
job_data_per_image: true
```

## 故障排除

### 常见问题

#### 1. 格式不支持
**问题**: 某些格式无法使用
**解决**: 检查可选依赖是否已安装

#### 2. 文件名包含无效字符
**问题**: 生成的文件名包含系统不支持的字符
**解决**: 插件会自动清理无效字符，或手动调整命名规则

#### 3. 性能问题
**问题**: 大批量保存时速度慢
**解决**: 
- 减少元数据保存
- 使用更快的格式 (如 WebP)
- 调整质量设置

#### 4. 内存不足
**问题**: 处理大量图像时内存不足
**解决**: 插件会自动进行内存管理，如仍有问题可重启 ComfyUI

### 日志和调试

插件会在控制台输出详细的日志信息：
- 信息级别: 正常操作状态
- 警告级别: 潜在问题
- 错误级别: 需要注意的问题

## 性能优化建议

### 1. 格式选择
- **WebP**: 平衡质量和文件大小的最佳选择
- **PNG**: 无损质量，但文件较大
- **JPEG**: 最小文件大小，有损压缩
- **AVIF**: 最新格式，优秀的压缩比

### 2. 质量设置
- **WebP/JPEG**: 75-85 通常是最佳平衡点
- **AVIF**: 60-70 可获得优秀效果
- **PNG**: 质量设置不影响图像质量，只影响压缩级别

### 3. 批量处理
- 大批量保存时，插件会自动使用多线程处理
- 避免同时保存过多不同格式
- 合理设置计数器位数

## 技术支持

如遇到问题，请提供以下信息：
1. ComfyUI 版本
2. 插件版本 (v3.0)
3. 错误日志
4. 使用的配置参数
5. 系统环境信息

## 更新日志

### v3.0 (重构版本)
- 完全重构的模块化架构
- 新增性能优化和缓存机制
- 改进的错误处理和日志系统
- 更好的内存管理
- 增强的配置验证
- 完善的单元测试覆盖

### 向后兼容性
v3.0 保持与之前版本的配置兼容性，现有工作流无需修改即可使用。
