# Save Image Extended v3.0 开发者文档

## 架构概述

Save Image Extended v3.0 采用模块化架构设计，遵循 SOLID 原则，提供高度可扩展和可维护的代码结构。

## 核心模块

### 1. 配置管理 (`core/config.py`)

#### SaveConfig
数据类，定义所有配置参数：
```python
@dataclass
class SaveConfig:
    filename_prefix: str = "ComfyUI"
    filename_keys: str = "sampler_name, cfg, steps, %F %H-%M-%S"
    output_format: str = ".webp"
    quality: int = 75
    # ... 其他配置项
```

#### ConfigManager
配置管理器，提供验证、预设和帮助功能：
```python
manager = ConfigManager()
config = manager.get_preset_config("基础配置")
validation = manager.validate_config(config)
```

### 2. 文件名生成 (`core/filename_generator.py`)

#### FileNameGenerator
负责生成文件名和文件夹名：
```python
generator = FileNameGenerator(config)
filename = generator.generate_filename(prompt, timestamp)
foldername = generator.generate_foldername(prompt, timestamp)
```

#### ParameterExtractor
从 ComfyUI 提示词中提取参数，支持缓存：
```python
extractor = ParameterExtractor()
values = extractor.find_parameter_values(prompt, keys)
```

### 3. 图像保存 (`core/image_saver.py`)

#### ImageSaver
协调器类，整合所有组件：
```python
saver = ImageSaver(config, output_dir)
results = saver.save_images(images, prompt, extra_pnginfo)
```

### 4. 格式策略 (`strategies/`)

使用策略模式处理不同图像格式：

#### FormatStrategy (抽象基类)
```python
class FormatStrategy(ABC):
    @abstractmethod
    def save_image(self, image: Image.Image, filepath: str, 
                   config: SaveConfig, metadata: Dict) -> bool
```

#### 具体策略实现
- `PngStrategy`: PNG 格式处理
- `WebpStrategy`: WebP 格式处理
- `AvifStrategy`: AVIF 格式处理
- 等等...

### 5. 元数据处理 (`core/metadata_handler.py`)

#### MetadataHandler
处理图像元数据的保存和转换：
```python
handler = MetadataHandler()
metadata = handler.prepare_metadata(prompt, extra_pnginfo, positive_text, negative_text)
```

### 6. 路径管理 (`core/path_manager.py`)

#### PathManager
处理文件路径创建和验证：
```python
manager = PathManager()
full_path = manager.create_output_path(output_dir, foldername, filename)
```

### 7. 计数器管理 (`core/counter_manager.py`)

#### CounterManager
管理文件计数器，支持缓存：
```python
manager = CounterManager()
counter = manager.get_next_counter(folder_path, filename_pattern)
```

### 8. 作业数据导出 (`core/job_data_exporter.py`)

#### JobDataExporter
导出作业数据到 JSON 文件：
```python
exporter = JobDataExporter(config)
exporter.export_job_data(prompt, extra_pnginfo, output_path)
```

### 9. 错误处理 (`core/error_handler.py`)

#### ErrorHandler
统一的错误处理和日志系统：
```python
handler = ErrorHandler()
with handler.create_error_context("保存图像"):
    # 执行操作
    pass
```

### 10. 性能优化 (`core/performance_optimizer.py`)

#### PerformanceOptimizer
提供缓存、批量处理和性能监控：
```python
optimizer = PerformanceOptimizer()
result = optimizer.optimize_operation("operation", func, *args)
```

## 设计模式

### 1. 策略模式 (Strategy Pattern)
用于处理不同的图像格式，每种格式有独立的保存策略。

### 2. 工厂模式 (Factory Pattern)
在 `ImageSaver` 中创建格式策略实例。

### 3. 单例模式 (Singleton Pattern)
全局错误处理器使用单例模式。

### 4. 观察者模式 (Observer Pattern)
性能监控器可以观察各种操作的执行情况。

## 扩展指南

### 添加新的图像格式

1. **创建策略类**:
```python
# strategies/new_format_strategy.py
class NewFormatStrategy(FormatStrategy):
    def save_image(self, image: Image.Image, filepath: str, 
                   config: SaveConfig, metadata: Dict) -> bool:
        # 实现保存逻辑
        pass
```

2. **注册策略**:
```python
# core/image_saver.py
def _create_format_strategies(self) -> Dict[str, FormatStrategy]:
    return {
        # ... 现有格式
        '.newformat': NewFormatStrategy(),
    }
```

3. **更新配置**:
```python
# 在 INPUT_TYPES 中添加新格式
output_formats = ['.webp', '.png', '.newformat']
```

### 添加新的配置参数

1. **更新 SaveConfig**:
```python
@dataclass
class SaveConfig:
    # ... 现有参数
    new_parameter: str = "default_value"
```

2. **更新验证逻辑**:
```python
# core/config.py ConfigManager.validate_config()
if not self._validate_new_parameter(config.new_parameter):
    result.add_error("新参数验证失败")
```

3. **更新 INPUT_TYPES**:
```python
"new_parameter": ("STRING", {"default": "default_value"}),
```

### 添加新的缓存策略

1. **扩展 CacheManager**:
```python
class CustomCacheManager(CacheManager):
    def custom_cache_logic(self):
        # 实现自定义缓存逻辑
        pass
```

2. **在相关模块中使用**:
```python
self.cache_manager = CustomCacheManager()
```

## 测试指南

### 运行测试
```bash
# 运行所有测试
python tests/run_tests.py

# 运行特定模块测试
python tests/run_tests.py config
```

### 编写新测试
```python
# tests/test_new_module.py
import unittest
from core.new_module import NewClass

class TestNewClass(unittest.TestCase):
    def setUp(self):
        self.instance = NewClass()
    
    def test_functionality(self):
        result = self.instance.method()
        self.assertEqual(result, expected_value)
```

## 性能优化

### 缓存策略
- **文件名生成**: 缓存参数提取结果
- **计数器管理**: 缓存文件夹计数器
- **元数据处理**: 缓存元数据转换结果

### 批量处理
- 小批量 (≤2): 单线程处理
- 大批量 (>2): 多线程并行处理

### 内存管理
- 自动垃圾回收
- 内存使用监控
- 缓存大小限制

## 调试和日志

### 日志级别
- **DEBUG**: 详细的调试信息
- **INFO**: 一般信息
- **WARNING**: 警告信息
- **ERROR**: 错误信息

### 启用调试模式
```python
import logging
logging.getLogger('save_image_extended').setLevel(logging.DEBUG)
```

### 性能监控
```python
optimizer = PerformanceOptimizer()
report = optimizer.get_performance_report()
print(report)
```

## 代码规范

### 命名约定
- 类名: PascalCase (`SaveConfig`)
- 方法名: snake_case (`generate_filename`)
- 常量: UPPER_CASE (`VERSION`)
- 私有方法: 前缀下划线 (`_internal_method`)

### 文档字符串
```python
def method(self, param: str) -> bool:
    """
    方法描述
    
    Args:
        param: 参数描述
        
    Returns:
        返回值描述
        
    Raises:
        Exception: 异常描述
    """
```

### 类型注解
所有公共方法都应该包含类型注解：
```python
def process_image(self, image: Image.Image, config: SaveConfig) -> Optional[str]:
    pass
```

## 部署和发布

### 版本管理
版本号格式: `MAJOR.MINOR.PATCH`
- MAJOR: 不兼容的 API 变更
- MINOR: 向后兼容的功能添加
- PATCH: 向后兼容的错误修复

### 发布检查清单
1. 运行所有测试
2. 更新版本号
3. 更新文档
4. 检查依赖项
5. 验证向后兼容性

## 贡献指南

### 提交代码
1. Fork 项目
2. 创建功能分支
3. 编写测试
4. 提交代码
5. 创建 Pull Request

### 代码审查
- 遵循代码规范
- 包含适当的测试
- 更新相关文档
- 确保向后兼容性
